name: aks-set-up

on:
  workflow_dispatch

jobs:
  create-aks:
    runs-on: ubuntu-latest
    steps:

      # Step 1: Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4
 
      # Step 2: Azure Portal Login
      - name: Login to Azure
        run: az login --use-device-code  

      # Step 3: Set AKS Context
      - name: Set AKS Context
        id: set-context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.Resource_Group }} 
          cluster-name: ${{ secrets.AKS_NAME }}

      # Step 4: Verify Node
      - name: Verify Node
        run: |
          kubectl get nodes   

      # Step 5: Apply Taint to a Node
      - name: Taint AKS Node
        run: |
          NODE_NAME=$(kubectl get nodes -o jsonpath='{.items[0].metadata.name}')
          kubectl taint nodes $NODE_NAME type=gpn:NoSchedule --overwrite

      # Step 6: Apply Pod with Toleration
      - name: Deploy Pod with Toleration
        run: |
          kubectl apply -f aks/mithun1.yml

      # Step 7: Verify Taint
      - name: Verify Taint
        run: |
          NODE_NAME=$(kubectl get nodes -o jsonpath='{.items[0].metadata.name}')
          kubectl describe node $NODE_NAME | grep Taints
          
      # Step 8: Verify Pod Placement         
      - name: Verify Pod Status
        run: |
          kubectl get pods -o wide
